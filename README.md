## Виртуальная машина для веб-разработки

Виртуальная машина основата на утилите Vagrant, для работы нужно следующее:
 - [Vagrant](http://www.vagrantup.com/downloads.html)
 - [VirtualBox](https://www.virtualbox.org/wiki/Downloads)

В качестве гостевой ОС используется Debian 7.2 Wheezy.

После развертывания, запускается из консоли командой `vagrant up` либо командным файлом `bin\up.bat`. 
После этого начинается процесс инициализации, который длится достаточно долго, инициализация производится
только при первом запуске либо при обновлении.

Во время инициализации из интернета скачивается некоторое количество мегабайт, так что нужен неплохой интернет.
Подробнее о работе с утилитой можно почитать [здесь](http://habrahabr.ru/post/113354/). Описание установки
и настройки можно пропустить.

После окончания работы машину нужно корректно выключить командой `vagrant halt`, доступ к виртуальному серверу можно
получить с помощью `vagrant ssh` или напрямую - адрес машины `192.168.2.10`.

Сервер предоставляет следующие сервисы:
 - Веб-сервер (Apache 2 + PHP 5.4),
 - MySQL
 - PostgreSQL
 - Redis
 - Memcached
 - Sphinx
 - Exim4 в режиме "Internet site"
 - DNS
 
Так же внутри настроены SQLite, Vim, Python PIP, PHP Pear, PHPUnit (с дополнениями DbUnit и PHP_Invoker)
и другие приятные вещи.

Для пользователя `root` в MySQL и пользователя `postgres` в PostgreSQL установлен пароль `password`.

В переменных окружения Apache есть значение `DEBUG_SERVER = 1`

Для Sphinx реализован препроцессинг файла конфигурации, файлы отдельных приложений можно складывать в каталог
`/etc/sphinxsearch/conf.d/`.
Для запуска демона Sphinx необходимо в файле `/etc/default/sphinxsearch` установить опцию `START=yes`.


## Параметры, утилиты и командные файлы
### Настройки
Параметры хранятся в файле `params.ini`, эти параметры распространяются как на виртуальную машину, так и на утилиты.

Виртуальный сервер автоматически определяет DocumentRoot по заголовку Host, используется принцип
`(?P<document_root>.+?)\.loc`.
По умолчанию он ищет сайты в каталоге `D:\htdocs` для Windows и `/var/www` для Unix-like систем, это можно изменить
в файле `params.ini`.

IP-адрес виртуальной машины в закрытой виртуальной сети по умолчанию `192.168.2.10`, его можно изменить в файле
`params.ini`, после его изменения требуется повторить `vagrant provision`,
а так же `PatchHosts`.

### Командные файлы
В каталоге `bin` находятся утилиты и командные файлы. Они обеспечивают быстрый доступ к базовым командам утилиты Vagrant,
а так же дополнительные возможности, описанные ниже.

Командный файл `mysqldump.bat` предназначен для быстрого создания дампа всех баз MySQL,
дамп записывается в подкаталог `runtime`.

Аналогичные возможности есть и для других СУБД: `pg_dumpall.bat` - для PostgreSQL и `redis_dump.bat` - для Redis.

Утилита `sphinx_rotate` служит для обновления индекса сервера Sphinx.

### Утилита PatchHosts
Для обращения к доменам в зоне .loc, можно указать в качестве DNS-сервера `192.168.2.10`,
но это может (и скорее всего так и будет) привести к замедлению работы интернета.

Альтернативой этому является использование утилиты PatchHosts, которая просматривает папку `D:\htdocs` и дописывает
все нужные домены в файл `hosts`.

В случае, если утилита не сможет записать файл самостоятельно (в Windows 8.1 это всегда так, даже с правами администратора), 
она покажет нужный контент в блокноте, в этом случае нужно скопировать значения вручную в файл `hosts`.

### Обновление
Для обновления нужно скачать новую версию, например, с помощью `git pull`, и повторить `vagrant provision`.


## Известные проблемы
### DOCUMENT_ROOT
В данной конфигурации используется модуль Apache mod_vhost_alias, это приводит к проявлению [бага №26052](https://issues.apache.org/bugzilla/show_bug.cgi?id=26052),
при котором неверно устанавливается переменная `DOCUMENT_ROOT`.
Для PHP эта проблема решена с помощью [файла](https://github.com/Andre-487/VagrantWebdev/blob/master/provision/data/apache2/php_patch.php),
который [автоматически добавляется](https://github.com/Andre-487/VagrantWebdev/blob/master/provision/data/apache2/default#L16) веб-сервером к каждому скрипту без участия пользователя.
Но при использовании модуля mod_rewrite требуется добавлять к правилам `%{DOCUMENT_ROOT}`:

```ApacheConf
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule .* %{DOCUMENT_ROOT}/index.php [L]
```

Данный баг был исправлен в Apache 2.4, так что рано или поздно он станет историей.

### Доставка писем на удаленные сервера
Exim4 может доставлять письма на удаленные сервера, но многие почтовые провайдеры блокируют письма, отправленные
с локальных машин в целях борьбы со спамом. В качестве выхода можно посоветовать подобрать провайдера, который не блокирует
письма либо настроить Exim для использования в цепочке с другим почтовым сервером.
